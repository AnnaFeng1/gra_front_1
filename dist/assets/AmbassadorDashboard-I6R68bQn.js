import{s as P,u as fe,r as _,j as C,o as _e,k as ge,E as r,c as M,d as i,b as t,t as n,l as R,w as d,m as L,f as w,g as b,h,n as E,F as G,p as J,q as ye,v as we,i as be}from"./index-nCsIEKc5.js";import{T as xe}from"./TheHeader-DUIFwaDE.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";function Ce(){return P({url:"/api/ambassador/progress",method:"get"})}function Me(x=1001){return P({url:"/api/ambassador/camp/current",method:"get",params:{camp_id:x}})}function Pe(x){return P({url:"/api/ambassador/camp/count",method:"get",params:{camp_period_id:x}})}function De(){return P({url:"/api/ambassador/promotion/apply",method:"post"})}function $e(){return P({url:"/api/ambassador/team/leave",method:"post"})}function K(x){return P({url:"/api/ambassador/commission/detail",method:"get",params:{camp_period_id:x}})}function Ie(x){return P({url:"/api/ambassador/camp/current",method:"get",params:{camp_id:x}})}const Te={class:"dashboard-container"},Ae={class:"main-content"},Fe={class:"welcome-section"},Ve={class:"welcome-text"},Xe={class:"header-actions"},Ye={class:"content-container-vertical"},Ee={class:"combined-content"},ze={class:"camp-section"},Ne={class:"camp-info"},Se={class:"info-item"},qe={class:"info-value camp-name"},Be={class:"info-item"},Le={class:"info-value"},Ue={class:"info-item"},We={class:"level-progress-container"},je={class:"level-progress-info"},He={class:"level-markers"},Re={class:"stats-section"},Ge={class:"stats-content"},Je={class:"stat-item"},Ke={class:"stat-value"},Oe={class:"stat-item commission-item"},Qe={class:"stat-value"},Ze={class:"commission-detail-btn-wrapper"},es={class:"progress-content"},ss={class:"progress-info"},ts={class:"highlight"},as={class:"highlight"},os={class:"progress-actions"},ns={class:"commission-header"},is={class:"commission-info"},ls={class:"info-row"},rs={class:"info-value"},ds={class:"info-row"},cs={class:"info-value"},us={key:0,class:"info-row"},ms={class:"info-value"},ps={class:"info-row camp-id-input"},vs={class:"commission-total"},hs={class:"total-value"},fs={key:0,class:"loading-container"},_s={class:"commission-amount"},gs={key:2,class:"commission-footer"},ys={key:3,class:"commission-footer"},ws={class:"commission-summary"},bs={class:"summary-item"},xs={class:"summary-value"},ks={class:"summary-item"},Cs={class:"summary-value"},Ms={class:"dialog-footer"},Ps={__name:"AmbassadorDashboard",setup(x){const O=be();fe();const g=_({current_count:0,required_count:50}),c=_({camp_name:"",start_date:"",end_date:""}),p=_(0),T=_("￥0.00");_("");const U=_(null);let z=null;const V=_(!1),f=_({commission_type:"",camp_period_id:0,details:[],total_commission:0}),D=_(!1),y=_(1001),u=_({camp_name:"营期1001",start_date:"",end_date:""}),Q=()=>{const s=U.value;if(!s)return;const e=s.getContext("2d"),a=[],m=[],l=()=>{const o=s.parentElement;s.width=o.offsetWidth,s.height=o.offsetHeight};window.addEventListener("resize",l),l();class k{constructor(){this.x=Math.random()*s.width,this.y=Math.random()*s.height,this.size=Math.random()*3+1,this.speedX=Math.random()*1-.5,this.speedY=Math.random()*1-.5,this.color=`rgba(64, 158, 255, ${Math.random()*.5+.1})`}update(){(this.x>s.width||this.x<0)&&(this.speedX=-this.speedX),(this.y>s.height||this.y<0)&&(this.speedY=-this.speedY),this.x+=this.speedX,this.y+=this.speedY}draw(){e.fillStyle=this.color,e.beginPath(),e.arc(this.x,this.y,this.size,0,Math.PI*2),e.fill()}}class q{constructor(){this.x1=Math.random()*s.width,this.y1=Math.random()*s.height,this.x2=this.x1+(Math.random()*100-50),this.y2=this.y1+(Math.random()*100-50),this.speedX1=Math.random()*.5-.25,this.speedY1=Math.random()*.5-.25,this.speedX2=Math.random()*.5-.25,this.speedY2=Math.random()*.5-.25,this.width=Math.random()*1.5+.5,this.color=`rgba(64, 158, 255, ${Math.random()*.3+.1})`}update(){(this.x1>s.width||this.x1<0)&&(this.speedX1=-this.speedX1),(this.y1>s.height||this.y1<0)&&(this.speedY1=-this.speedY1),(this.x2>s.width||this.x2<0)&&(this.speedX2=-this.speedX2),(this.y2>s.height||this.y2<0)&&(this.speedY2=-this.speedY2),this.x1+=this.speedX1,this.y1+=this.speedY1,this.x2+=this.speedX2,this.y2+=this.speedY2}draw(){e.strokeStyle=this.color,e.lineWidth=this.width,e.beginPath(),e.moveTo(this.x1,this.y1),e.lineTo(this.x2,this.y2),e.stroke()}}const $=()=>{for(let o=0;o<15;o++)a.push(new k);for(let o=0;o<8;o++)m.push(new q)},Y=()=>{e.clearRect(0,0,s.width,s.height),m.forEach(o=>{o.update(),o.draw()}),a.forEach(o=>{o.update(),o.draw()}),B(),z=requestAnimationFrame(Y)},B=()=>{for(let o=0;o<a.length;o++)for(let v=o+1;v<a.length;v++){const A=a[o].x-a[v].x,F=a[o].y-a[v].y,I=Math.sqrt(A*A+F*F);I<100&&(e.beginPath(),e.strokeStyle=`rgba(64, 158, 255, ${.2-I/500})`,e.lineWidth=.8,e.moveTo(a[o].x,a[o].y),e.lineTo(a[v].x,a[v].y),e.stroke())}};return $(),Y(),()=>{window.removeEventListener("resize",l),z&&cancelAnimationFrame(z)}},Z=C(()=>{const s=p.value||0;return s>50?"高级推广大使":s>20?"中级推广大使":"初级推广大使"}),ee=C(()=>{const s=p.value||0;return s>50?"level-high":s>20?"level-medium":"level-basic"}),se=C(()=>{const s=p.value||0;return Math.min(100,Math.floor(s/50*100))}),te=C(()=>{const s=p.value||0;return s>50?"您已达到最高推广层级":s>20?`已推广 ${s} 人（中级）`:`已推广 ${s} 人（初级）`}),ae=C(()=>{const s=p.value||0;return s>50?"享受最高佣金比例":s>20?`距高级还需 ${Math.max(0,51-s)} 人`:`距中级还需 ${Math.max(0,21-s)} 人`}),oe=C(()=>{const s=p.value||0;return s>50?"#67C23A":s>20?"#E6A23C":"#409EFF"}),ne=C(()=>!g.value||typeof g.value.current_count!="number"||typeof g.value.required_count!="number"||g.value.required_count===0?0:Math.min(100,Math.floor(g.value.current_count/g.value.required_count*100))),ie=s=>s+"%",X=s=>s||"",le=async()=>{try{const s=await De();r.success(s.msg)}catch(s){r.error(s.message||"申请失败")}},re=async()=>{try{await r.confirm("确认要离开当前团队吗？","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"});const s=await $e();r.success(s.msg),await W()}catch(s){s!=="cancel"&&r.error(s.message||"操作失败")}},W=async()=>{try{const s=await getUserInfo();s.code===1&&s.data?userInfo.value=s.data:console.error("获取用户信息失败: 返回数据格式错误")}catch(s){console.error("获取用户信息失败",s),s.response&&(console.error("错误状态码:",s.response.status),console.error("错误详情:",s.response.data),s.response.status===401&&(r.error("登录状态已失效，请重新登录"),setTimeout(()=>{localStorage.removeItem("token"),O.push("/login")},1500)))}},de=async()=>{try{const s=await Ce();s.code===1&&s.data?g.value=s.data:console.error("获取成长进度失败: 返回数据格式错误")}catch(s){console.error("获取成长进度失败",s),g.value={current_count:0,required_count:50}}},ce=async()=>{try{const s=await Me(1001);s.code===1&&s.data?(c.value=s.data,await Promise.all([N(),S()])):(console.error("获取当前营期失败: 返回数据格式错误"),c.value={camp_name:"当前营期",start_date:"",end_date:"",camp_period_id:1001},await Promise.all([N(),S()]))}catch(s){console.error("获取当前营期失败",s),c.value={camp_name:"当前营期",start_date:"",end_date:"",camp_period_id:1001},await Promise.all([N(),S()])}},N=async()=>{var s;try{const e=await Pe(1001);p.value=((s=e.data)==null?void 0:s.success_count)||0}catch(e){console.error("获取推广数失败",e),p.value=0}},S=async()=>{try{const e=await K(1001);if(e.code===1&&e.data&&Array.isArray(e.data.details)&&e.data.details.length>0){const a=e.data.details.reduce((m,l)=>{let k=0;return l.commission_amount!==void 0&&l.commission_amount!==null&&(typeof l.commission_amount=="string"&&l.commission_amount.includes("￥")?k=parseFloat(l.commission_amount.replace("￥",""))||0:k=parseFloat(l.commission_amount)||0),m+k},0);T.value=`￥${a.toFixed(2)}`}else e.code===1&&e.data&&typeof e.data.total_commission=="number"?T.value=`￥${e.data.total_commission.toFixed(2)}`:T.value="￥0.00"}catch(s){console.error("获取佣金总额失败",s),T.value="￥0.00"}},ue=()=>{var a;const s=((a=f.value)==null?void 0:a.details)||[];return!s||s.length===0?"0.00":(s.reduce((m,l)=>m+(l.commission_amount||0),0)/s.length).toFixed(2)},j=async s=>{try{V.value=!0,D.value=!0;let e;s&&typeof s=="number"?e=s:e=parseInt(y.value)||1001,y.value=e;try{await me(e)}catch(m){console.error("获取营期信息失败，使用默认值",m)}r.info("正在加载佣金明细..."),console.log("请求营期ID:",e);const a=await K(e);a.code===1?(f.value=a.data||{},f.value.details&&f.value.details.length>0?(f.value.details.sort((m,l)=>new Date(l.time)-new Date(m.time)),r.success(`成功加载${u.value.camp_name||`营期${e}`}的佣金明细`)):r.warning(`${u.value.camp_name||`营期${e}`}中没有任何推广数据记录`)):r.error(a.msg||"获取佣金明细失败")}catch(e){console.error("获取佣金明细失败",e),e.message&&e.message.includes("doesn't exist")?r.error("佣金明细接口错误：数据库表不存在，请联系开发人员修复"):r.error("获取佣金明细失败，请稍后重试")}finally{D.value=!1}},me=async s=>{try{if(c.value&&c.value.camp_period_id===s){u.value={...c.value};return}const e=await Ie(s);e.code===1&&e.data?u.value=e.data:(u.value={camp_name:`营期${s}`,camp_period_id:s,start_date:"",end_date:""},console.warn(`获取营期${s}信息失败，使用默认值`))}catch(e){console.error("获取营期信息失败",e),u.value={camp_name:`营期${s}`,camp_period_id:s,start_date:"",end_date:""}}},pe=()=>{if(!y.value){r.warning("请输入有效的营期ID");return}const s=parseInt(y.value);if(isNaN(s)||s<=0){r.warning("营期ID必须是正整数");return}j(s)},ve=()=>{c.value&&c.value.camp_period_id?(y.value=c.value.camp_period_id,u.value={...c.value}):(y.value=1001,u.value={camp_name:"营期1001",start_date:"",end_date:""}),j()};_e(()=>{const s=document.createElement("link");s.rel="stylesheet",s.href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap",document.head.appendChild(s),he();const e=Q();ge(()=>{e&&e()})});const he=async()=>{try{await W(),await de(),await ce()}catch(s){console.error("加载数据失败",s),r({message:"数据加载失败：后端数据库查询存在问题，请联系系统管理员",type:"error",duration:8e3})}},H=s=>{if(s==null)return"￥0.00";if(typeof s=="string"&&s.includes("￥"))return s;const e=parseFloat(s);return isNaN(e)?"￥0.00":`￥${e.toFixed(2)}`};return(s,e)=>{const a=w("el-button"),m=w("el-progress"),l=w("el-card"),k=w("el-input"),q=w("el-icon"),$=w("el-table-column"),Y=w("el-table"),B=w("el-empty"),o=w("el-dialog");return b(),M("div",Te,[i(xe),t("div",Ae,[t("div",Fe,[t("canvas",{ref_key:"welcomeCanvas",ref:U,class:"welcome-canvas"},null,512),t("h2",Ve,"欢迎，"+n(s.userInfo.username),1),t("div",Xe,[s.userInfo.team_name?(b(),R(a,{key:0,type:"danger",onClick:re},{default:d(()=>e[3]||(e[3]=[h("离开团队")])),_:1})):L("",!0)])]),t("div",Ye,[i(l,{class:"combined-card"},{header:d(()=>e[4]||(e[4]=[t("div",{class:"card-header"},[t("span",null,[t("i",{class:"el-icon-date"}),h(" 营期与业绩")])],-1)])),default:d(()=>[t("div",Ee,[t("div",ze,[e[11]||(e[11]=t("h3",{class:"section-title"},"当前营期",-1)),t("div",Ne,[t("div",Se,[e[5]||(e[5]=t("span",{class:"info-label"},"营期名称:",-1)),t("span",qe,n(c.value.camp_name),1)]),t("div",Be,[e[6]||(e[6]=t("span",{class:"info-label"},"营期时间:",-1)),t("span",Le,n(X(c.value.start_date))+" 至 "+n(X(c.value.end_date)),1)]),t("div",Ue,[e[7]||(e[7]=t("span",{class:"info-label"},"推广层级:",-1)),t("span",{class:E(["info-value level-badge",ee.value])},n(Z.value),3)]),t("div",We,[t("div",je,[t("span",null,n(te.value),1),t("span",null,n(ae.value),1)]),i(m,{percentage:se.value,"stroke-width":10,color:oe.value,class:"level-progress"},null,8,["percentage","color"]),t("div",He,[t("div",{class:E(["marker marker-initial",{active:p.value>0}])},e[8]||(e[8]=[t("div",{class:"marker-dot"},null,-1),t("div",{class:"marker-label"},"初级",-1)]),2),t("div",{class:E(["marker marker-medium",{active:p.value>20}])},e[9]||(e[9]=[t("div",{class:"marker-dot"},null,-1),t("div",{class:"marker-label"},"中级",-1)]),2),t("div",{class:E(["marker marker-high",{active:p.value>50}])},e[10]||(e[10]=[t("div",{class:"marker-dot"},null,-1),t("div",{class:"marker-label"},"高级",-1)]),2)])])])]),e[19]||(e[19]=t("div",{class:"section-divider"},null,-1)),t("div",Re,[e[18]||(e[18]=t("h3",{class:"section-title"},"业绩数据",-1)),t("div",Ge,[t("div",Je,[e[12]||(e[12]=t("div",{class:"stat-title"},"成功推广数",-1)),t("div",Ke,n(p.value),1),e[13]||(e[13]=t("div",{class:"stat-desc"},"本营期推广",-1))]),e[17]||(e[17]=t("div",{class:"stat-divider"},null,-1)),t("div",Oe,[e[15]||(e[15]=t("div",{class:"stat-title"},"佣金总额",-1)),t("div",Qe,n(T.value),1),e[16]||(e[16]=t("div",{class:"stat-desc"},"累计收益",-1)),t("div",Ze,[i(a,{type:"primary",size:"default",class:"commission-detail-btn",onClick:ve},{default:d(()=>e[14]||(e[14]=[t("i",{class:"el-icon-document"},null,-1),h(" 佣金明细 ")])),_:1})])])])])])]),_:1}),i(l,{class:"progress-card"},{header:d(()=>e[20]||(e[20]=[t("div",{class:"card-header"},[t("span",null,[t("i",{class:"el-icon-rank"}),h(" 成长进度")])],-1)])),default:d(()=>[t("div",es,[e[25]||(e[25]=t("div",{class:"progress-title"},"当前进度",-1)),i(m,{percentage:ne.value,"stroke-width":20,status:"success",format:ie,class:"custom-progress"},null,8,["percentage"]),t("div",ss,[e[21]||(e[21]=h(" 已推广 ")),t("span",ts,n(g.value.current_count||0),1),e[22]||(e[22]=h(" 人， 目标 ")),t("span",as,n(g.value.required_count||50),1),e[23]||(e[23]=h(" 人 "))]),t("div",os,[i(a,{type:"primary",onClick:le,class:"promotion-btn"},{default:d(()=>e[24]||(e[24]=[h("申请晋升")])),_:1})])])]),_:1})])]),i(o,{modelValue:V.value,"onUpdate:modelValue":e[2]||(e[2]=v=>V.value=v),title:"佣金明细",width:"750px",class:"commission-dialog","close-on-click-modal":!1,"destroy-on-close":""},{footer:d(()=>[t("span",Ms,[i(a,{type:"primary",onClick:e[1]||(e[1]=v=>V.value=!1)},{default:d(()=>e[38]||(e[38]=[h("关闭")])),_:1})])]),default:d(()=>{var v,A,F;return[t("div",ns,[t("div",is,[t("div",ls,[e[26]||(e[26]=t("span",{class:"info-label"},"佣金类型:",-1)),t("span",rs,n(f.value.commission_type||"直接转化佣金"),1)]),t("div",ds,[e[29]||(e[29]=t("span",{class:"info-label"},"当前营期:",-1)),t("span",cs,[D.value?(b(),M(G,{key:0},[e[27]||(e[27]=t("i",{class:"el-icon-loading",style:{"margin-right":"5px"}},null,-1)),e[28]||(e[28]=h("加载中... "))],64)):(b(),M(G,{key:1},[h(n(u.value.camp_name||`营期${y.value}`),1)],64))])]),u.value.start_date||u.value.end_date?(b(),M("div",us,[e[30]||(e[30]=t("span",{class:"info-label"},"营期时间:",-1)),t("span",ms,n(X(u.value.start_date))+" 至 "+n(X(u.value.end_date)),1)])):L("",!0),t("div",ps,[e[32]||(e[32]=t("span",{class:"info-label"},"营期ID:",-1)),i(k,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=I=>y.value=I),size:"small",style:{width:"120px"},placeholder:"营期ID",type:"number"},null,8,["modelValue"]),i(a,{size:"small",type:"primary",onClick:pe,icon:J(ye),style:{"margin-left":"10px"}},{default:d(()=>e[31]||(e[31]=[h("刷新")])),_:1},8,["icon"])])]),t("div",vs,[e[33]||(e[33]=t("span",{class:"total-label"},"总佣金:",-1)),t("span",hs,n(H(f.value.total_commission)),1)])]),D.value?(b(),M("div",fs,[i(q,{class:"is-loading"},{default:d(()=>[i(J(we))]),_:1}),e[34]||(e[34]=t("span",null,"正在加载数据...",-1))])):(b(),R(Y,{key:1,data:f.value.details||[],style:{width:"100%"},stripe:"",border:""},{default:d(()=>[i($,{label:"客户ID",prop:"customer_id",width:"100",align:"center"}),i($,{label:"客户姓名",prop:"customer_name",width:"130",align:"center"}),i($,{label:"佣金金额",width:"150",align:"center"},{default:d(I=>[t("span",_s,n(H(I.row.commission_amount)),1)]),_:1}),i($,{label:"时间",prop:"time","min-width":"180",align:"center"})]),_:1},8,["data"])),!D.value&&!((v=f.value.details)!=null&&v.length)?(b(),M("div",gs,[i(B,{description:"当前营期没有佣金明细记录","image-size":120},{description:d(()=>[t("p",null,"在营期ID: "+n(y.value)+" 中没有任何推广数据",1),e[35]||(e[35]=t("p",{class:"empty-hint"},"您可以尝试查询其他营期或联系管理员",-1))]),_:1})])):!D.value&&((A=f.value.details)!=null&&A.length)?(b(),M("div",ys,[t("div",ws,[t("div",bs,[e[36]||(e[36]=t("span",{class:"summary-label"},"客户数量:",-1)),t("span",xs,n(((F=f.value.details)==null?void 0:F.length)||0)+"位",1)]),t("div",ks,[e[37]||(e[37]=t("span",{class:"summary-label"},"平均佣金:",-1)),t("span",Cs,"￥"+n(ue()),1)])])])):L("",!0)]}),_:1},8,["modelValue"])])}}},Ts=ke(Ps,[["__scopeId","data-v-7b1d63d2"]]);export{Ts as default};
