import{s as k,_ as ge,r as _,i as M,o as ye,j as we,E as c,c as P,b as t,d as i,w as r,t as n,k as J,l as U,f as b,g as x,h as v,n as E,F as K,m as O,u as be,p as xe,q as ke}from"./index-Bt0verpb.js";function Ce(){return k({url:"/api/ambassador/info",method:"get"}).then(d=>(d.data||(console.warn("用户信息接口返回数据为空，使用默认值"),d.data={username:"用户",role:"ambassador",team_name:""}),d)).catch(d=>(console.error("获取用户信息失败",d),{code:0,msg:d.message||"获取用户信息失败",data:{username:"用户",role:"ambassador",team_name:""}}))}function Me(){return k({url:"/api/ambassador/progress",method:"get"})}function Pe(d=1001){return k({url:"/api/ambassador/camp/current",method:"get",params:{camp_id:d}})}function De(d){return k({url:"/api/ambassador/camp/count",method:"get",params:{camp_period_id:d}})}function $e(){return k({url:"/api/ambassador/promotion/apply",method:"post"})}function Ie(){return k({url:"/api/ambassador/team/leave",method:"post"})}function Q(d){return k({url:"/api/ambassador/commission/detail",method:"get",params:{camp_period_id:d}})}function Te(d){return k({url:"/api/ambassador/camp/current",method:"get",params:{camp_id:d}})}const Ae={class:"dashboard-container"},Fe={class:"header"},Ve={class:"user-info"},Xe={class:"main-content"},Ye={class:"welcome-section"},Ee={class:"welcome-text"},ze={class:"header-actions"},Ne={class:"content-container-vertical"},qe={class:"combined-content"},Se={class:"camp-section"},Be={class:"camp-info"},Le={class:"info-item"},Ue={class:"info-value camp-name"},We={class:"info-item"},je={class:"info-value"},Re={class:"info-item"},Ge={class:"level-progress-container"},He={class:"level-progress-info"},Je={class:"level-markers"},Ke={class:"stats-section"},Oe={class:"stats-content"},Qe={class:"stat-item"},Ze={class:"stat-value"},es={class:"stat-item commission-item"},ss={class:"stat-value"},ts={class:"commission-detail-btn-wrapper"},as={class:"progress-content"},os={class:"progress-info"},ns={class:"highlight"},is={class:"highlight"},ls={class:"progress-actions"},rs={class:"commission-header"},ds={class:"commission-info"},cs={class:"info-row"},us={class:"info-value"},ms={class:"info-row"},ps={class:"info-value"},vs={key:0,class:"info-row"},hs={class:"info-value"},fs={class:"info-row camp-id-input"},_s={class:"commission-total"},gs={class:"total-value"},ys={key:0,class:"loading-container"},ws={class:"commission-amount"},bs={key:2,class:"commission-footer"},xs={key:3,class:"commission-footer"},ks={class:"commission-summary"},Cs={class:"summary-item"},Ms={class:"summary-value"},Ps={class:"summary-item"},Ds={class:"summary-value"},$s={class:"dialog-footer"},Is={__name:"AmbassadorDashboard",setup(d){const W=be(),z=_({}),y=_({current_count:0,required_count:50}),u=_({camp_name:"",start_date:"",end_date:""}),h=_(0),T=_("￥0.00");_("");const j=_(null);let N=null;const V=_(!1),g=_({commission_type:"",camp_period_id:0,details:[],total_commission:0}),D=_(!1),w=_(1001),m=_({camp_name:"营期1001",start_date:"",end_date:""}),Z=()=>{const s=j.value;if(!s)return;const e=s.getContext("2d"),a=[],p=[],l=()=>{const o=s.parentElement;s.width=o.offsetWidth,s.height=o.offsetHeight};window.addEventListener("resize",l),l();class C{constructor(){this.x=Math.random()*s.width,this.y=Math.random()*s.height,this.size=Math.random()*3+1,this.speedX=Math.random()*1-.5,this.speedY=Math.random()*1-.5,this.color=`rgba(64, 158, 255, ${Math.random()*.5+.1})`}update(){(this.x>s.width||this.x<0)&&(this.speedX=-this.speedX),(this.y>s.height||this.y<0)&&(this.speedY=-this.speedY),this.x+=this.speedX,this.y+=this.speedY}draw(){e.fillStyle=this.color,e.beginPath(),e.arc(this.x,this.y,this.size,0,Math.PI*2),e.fill()}}class B{constructor(){this.x1=Math.random()*s.width,this.y1=Math.random()*s.height,this.x2=this.x1+(Math.random()*100-50),this.y2=this.y1+(Math.random()*100-50),this.speedX1=Math.random()*.5-.25,this.speedY1=Math.random()*.5-.25,this.speedX2=Math.random()*.5-.25,this.speedY2=Math.random()*.5-.25,this.width=Math.random()*1.5+.5,this.color=`rgba(64, 158, 255, ${Math.random()*.3+.1})`}update(){(this.x1>s.width||this.x1<0)&&(this.speedX1=-this.speedX1),(this.y1>s.height||this.y1<0)&&(this.speedY1=-this.speedY1),(this.x2>s.width||this.x2<0)&&(this.speedX2=-this.speedX2),(this.y2>s.height||this.y2<0)&&(this.speedY2=-this.speedY2),this.x1+=this.speedX1,this.y1+=this.speedY1,this.x2+=this.speedX2,this.y2+=this.speedY2}draw(){e.strokeStyle=this.color,e.lineWidth=this.width,e.beginPath(),e.moveTo(this.x1,this.y1),e.lineTo(this.x2,this.y2),e.stroke()}}const $=()=>{for(let o=0;o<15;o++)a.push(new C);for(let o=0;o<8;o++)p.push(new B)},Y=()=>{e.clearRect(0,0,s.width,s.height),p.forEach(o=>{o.update(),o.draw()}),a.forEach(o=>{o.update(),o.draw()}),L(),N=requestAnimationFrame(Y)},L=()=>{for(let o=0;o<a.length;o++)for(let f=o+1;f<a.length;f++){const A=a[o].x-a[f].x,F=a[o].y-a[f].y,I=Math.sqrt(A*A+F*F);I<100&&(e.beginPath(),e.strokeStyle=`rgba(64, 158, 255, ${.2-I/500})`,e.lineWidth=.8,e.moveTo(a[o].x,a[o].y),e.lineTo(a[f].x,a[f].y),e.stroke())}};return $(),Y(),()=>{window.removeEventListener("resize",l),N&&cancelAnimationFrame(N)}},ee=M(()=>{const s=h.value||0;return s>50?"高级推广大使":s>20?"中级推广大使":"初级推广大使"}),se=M(()=>{const s=h.value||0;return s>50?"level-high":s>20?"level-medium":"level-basic"}),te=M(()=>{const s=h.value||0;return Math.min(100,Math.floor(s/50*100))}),ae=M(()=>{const s=h.value||0;return s>50?"您已达到最高推广层级":s>20?`已推广 ${s} 人（中级）`:`已推广 ${s} 人（初级）`}),oe=M(()=>{const s=h.value||0;return s>50?"享受最高佣金比例":s>20?`距高级还需 ${Math.max(0,51-s)} 人`:`距中级还需 ${Math.max(0,21-s)} 人`}),ne=M(()=>{const s=h.value||0;return s>50?"#67C23A":s>20?"#E6A23C":"#409EFF"}),ie=M(()=>!y.value||typeof y.value.current_count!="number"||typeof y.value.required_count!="number"||y.value.required_count===0?0:Math.min(100,Math.floor(y.value.current_count/y.value.required_count*100))),le=s=>s+"%",X=s=>s||"",re=()=>{W.push("/profile")},de=async()=>{try{const s=await $e();c.success(s.msg)}catch(s){c.error(s.message||"申请失败")}},ce=async()=>{try{await c.confirm("确认要离开当前团队吗？","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"});const s=await Ie();c.success(s.msg),await R()}catch(s){s!=="cancel"&&c.error(s.message||"操作失败")}},R=async()=>{try{const s=await Ce();s.code===1&&s.data?z.value=s.data:console.error("获取用户信息失败: 返回数据格式错误")}catch(s){console.error("获取用户信息失败",s),s.response&&(console.error("错误状态码:",s.response.status),console.error("错误详情:",s.response.data),s.response.status===401&&(c.error("登录状态已失效，请重新登录"),setTimeout(()=>{localStorage.removeItem("token"),W.push("/login")},1500)))}},ue=async()=>{try{const s=await Me();s.code===1&&s.data?y.value=s.data:console.error("获取成长进度失败: 返回数据格式错误")}catch(s){console.error("获取成长进度失败",s),y.value={current_count:0,required_count:50}}},me=async()=>{try{const s=await Pe(1001);s.code===1&&s.data?(u.value=s.data,await Promise.all([q(),S()])):(console.error("获取当前营期失败: 返回数据格式错误"),u.value={camp_name:"当前营期",start_date:"",end_date:"",camp_period_id:1001},await Promise.all([q(),S()]))}catch(s){console.error("获取当前营期失败",s),u.value={camp_name:"当前营期",start_date:"",end_date:"",camp_period_id:1001},await Promise.all([q(),S()])}},q=async()=>{var s;try{const e=await De(1001);h.value=((s=e.data)==null?void 0:s.success_count)||0}catch(e){console.error("获取推广数失败",e),h.value=0}},S=async()=>{try{const e=await Q(1001);if(e.code===1&&e.data&&Array.isArray(e.data.details)&&e.data.details.length>0){const a=e.data.details.reduce((p,l)=>{let C=0;return l.commission_amount!==void 0&&l.commission_amount!==null&&(typeof l.commission_amount=="string"&&l.commission_amount.includes("￥")?C=parseFloat(l.commission_amount.replace("￥",""))||0:C=parseFloat(l.commission_amount)||0),p+C},0);T.value=`￥${a.toFixed(2)}`}else e.code===1&&e.data&&typeof e.data.total_commission=="number"?T.value=`￥${e.data.total_commission.toFixed(2)}`:T.value="￥0.00"}catch(s){console.error("获取佣金总额失败",s),T.value="￥0.00"}},pe=()=>{var a;const s=((a=g.value)==null?void 0:a.details)||[];return!s||s.length===0?"0.00":(s.reduce((p,l)=>p+(l.commission_amount||0),0)/s.length).toFixed(2)},G=async s=>{try{V.value=!0,D.value=!0;let e;s&&typeof s=="number"?e=s:e=parseInt(w.value)||1001,w.value=e;try{await ve(e)}catch(p){console.error("获取营期信息失败，使用默认值",p)}c.info("正在加载佣金明细..."),console.log("请求营期ID:",e);const a=await Q(e);a.code===1?(g.value=a.data||{},g.value.details&&g.value.details.length>0?(g.value.details.sort((p,l)=>new Date(l.time)-new Date(p.time)),c.success(`成功加载${m.value.camp_name||`营期${e}`}的佣金明细`)):c.warning(`${m.value.camp_name||`营期${e}`}中没有任何推广数据记录`)):c.error(a.msg||"获取佣金明细失败")}catch(e){console.error("获取佣金明细失败",e),e.message&&e.message.includes("doesn't exist")?c.error("佣金明细接口错误：数据库表不存在，请联系开发人员修复"):c.error("获取佣金明细失败，请稍后重试")}finally{D.value=!1}},ve=async s=>{try{if(u.value&&u.value.camp_period_id===s){m.value={...u.value};return}const e=await Te(s);e.code===1&&e.data?m.value=e.data:(m.value={camp_name:`营期${s}`,camp_period_id:s,start_date:"",end_date:""},console.warn(`获取营期${s}信息失败，使用默认值`))}catch(e){console.error("获取营期信息失败",e),m.value={camp_name:`营期${s}`,camp_period_id:s,start_date:"",end_date:""}}},he=()=>{if(!w.value){c.warning("请输入有效的营期ID");return}const s=parseInt(w.value);if(isNaN(s)||s<=0){c.warning("营期ID必须是正整数");return}G(s)},fe=()=>{u.value&&u.value.camp_period_id?(w.value=u.value.camp_period_id,m.value={...u.value}):(w.value=1001,m.value={camp_name:"营期1001",start_date:"",end_date:""}),G()};ye(()=>{const s=document.createElement("link");s.rel="stylesheet",s.href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap",document.head.appendChild(s),_e();const e=Z();we(()=>{e&&e()})});const _e=async()=>{try{await R(),await ue(),await me()}catch(s){console.error("加载数据失败",s),c({message:"数据加载失败：后端数据库查询存在问题，请联系系统管理员",type:"error",duration:8e3})}},H=s=>{if(s==null)return"￥0.00";if(typeof s=="string"&&s.includes("￥"))return s;const e=parseFloat(s);return isNaN(e)?"￥0.00":`￥${e.toFixed(2)}`};return(s,e)=>{const a=b("el-button"),p=b("el-progress"),l=b("el-card"),C=b("el-input"),B=b("el-icon"),$=b("el-table-column"),Y=b("el-table"),L=b("el-empty"),o=b("el-dialog");return x(),P("div",Ae,[t("div",Fe,[e[4]||(e[4]=t("div",{class:"logo"},"营销推广管理系统",-1)),t("div",Ve,[i(a,{class:"user-center-btn",onClick:re},{default:r(()=>e[3]||(e[3]=[t("i",{class:"el-icon-user"},null,-1),v(" 个人中心 ")])),_:1})])]),t("div",Xe,[t("div",Ye,[t("canvas",{ref_key:"welcomeCanvas",ref:j,class:"welcome-canvas"},null,512),t("h2",Ee,"欢迎，"+n(z.value.username),1),t("div",ze,[z.value.team_name?(x(),J(a,{key:0,type:"danger",onClick:ce},{default:r(()=>e[5]||(e[5]=[v("离开团队")])),_:1})):U("",!0)])]),t("div",Ne,[i(l,{class:"combined-card"},{header:r(()=>e[6]||(e[6]=[t("div",{class:"card-header"},[t("span",null,[t("i",{class:"el-icon-date"}),v(" 营期与业绩")])],-1)])),default:r(()=>[t("div",qe,[t("div",Se,[e[13]||(e[13]=t("h3",{class:"section-title"},"当前营期",-1)),t("div",Be,[t("div",Le,[e[7]||(e[7]=t("span",{class:"info-label"},"营期名称:",-1)),t("span",Ue,n(u.value.camp_name),1)]),t("div",We,[e[8]||(e[8]=t("span",{class:"info-label"},"营期时间:",-1)),t("span",je,n(X(u.value.start_date))+" 至 "+n(X(u.value.end_date)),1)]),t("div",Re,[e[9]||(e[9]=t("span",{class:"info-label"},"推广层级:",-1)),t("span",{class:E(["info-value level-badge",se.value])},n(ee.value),3)]),t("div",Ge,[t("div",He,[t("span",null,n(ae.value),1),t("span",null,n(oe.value),1)]),i(p,{percentage:te.value,"stroke-width":10,color:ne.value,class:"level-progress"},null,8,["percentage","color"]),t("div",Je,[t("div",{class:E(["marker marker-initial",{active:h.value>0}])},e[10]||(e[10]=[t("div",{class:"marker-dot"},null,-1),t("div",{class:"marker-label"},"初级",-1)]),2),t("div",{class:E(["marker marker-medium",{active:h.value>20}])},e[11]||(e[11]=[t("div",{class:"marker-dot"},null,-1),t("div",{class:"marker-label"},"中级",-1)]),2),t("div",{class:E(["marker marker-high",{active:h.value>50}])},e[12]||(e[12]=[t("div",{class:"marker-dot"},null,-1),t("div",{class:"marker-label"},"高级",-1)]),2)])])])]),e[21]||(e[21]=t("div",{class:"section-divider"},null,-1)),t("div",Ke,[e[20]||(e[20]=t("h3",{class:"section-title"},"业绩数据",-1)),t("div",Oe,[t("div",Qe,[e[14]||(e[14]=t("div",{class:"stat-title"},"成功推广数",-1)),t("div",Ze,n(h.value),1),e[15]||(e[15]=t("div",{class:"stat-desc"},"本营期推广",-1))]),e[19]||(e[19]=t("div",{class:"stat-divider"},null,-1)),t("div",es,[e[17]||(e[17]=t("div",{class:"stat-title"},"佣金总额",-1)),t("div",ss,n(T.value),1),e[18]||(e[18]=t("div",{class:"stat-desc"},"累计收益",-1)),t("div",ts,[i(a,{type:"primary",size:"default",class:"commission-detail-btn",onClick:fe},{default:r(()=>e[16]||(e[16]=[t("i",{class:"el-icon-document"},null,-1),v(" 佣金明细 ")])),_:1})])])])])])]),_:1}),i(l,{class:"progress-card"},{header:r(()=>e[22]||(e[22]=[t("div",{class:"card-header"},[t("span",null,[t("i",{class:"el-icon-rank"}),v(" 成长进度")])],-1)])),default:r(()=>[t("div",as,[e[27]||(e[27]=t("div",{class:"progress-title"},"当前进度",-1)),i(p,{percentage:ie.value,"stroke-width":20,status:"success",format:le,class:"custom-progress"},null,8,["percentage"]),t("div",os,[e[23]||(e[23]=v(" 已推广 ")),t("span",ns,n(y.value.current_count||0),1),e[24]||(e[24]=v(" 人， 目标 ")),t("span",is,n(y.value.required_count||50),1),e[25]||(e[25]=v(" 人 "))]),t("div",ls,[i(a,{type:"primary",onClick:de,class:"promotion-btn"},{default:r(()=>e[26]||(e[26]=[v("申请晋升")])),_:1})])])]),_:1})])]),i(o,{modelValue:V.value,"onUpdate:modelValue":e[2]||(e[2]=f=>V.value=f),title:"佣金明细",width:"750px",class:"commission-dialog","close-on-click-modal":!1,"destroy-on-close":""},{footer:r(()=>[t("span",$s,[i(a,{type:"primary",onClick:e[1]||(e[1]=f=>V.value=!1)},{default:r(()=>e[40]||(e[40]=[v("关闭")])),_:1})])]),default:r(()=>{var f,A,F;return[t("div",rs,[t("div",ds,[t("div",cs,[e[28]||(e[28]=t("span",{class:"info-label"},"佣金类型:",-1)),t("span",us,n(g.value.commission_type||"直接转化佣金"),1)]),t("div",ms,[e[31]||(e[31]=t("span",{class:"info-label"},"当前营期:",-1)),t("span",ps,[D.value?(x(),P(K,{key:0},[e[29]||(e[29]=t("i",{class:"el-icon-loading",style:{"margin-right":"5px"}},null,-1)),e[30]||(e[30]=v("加载中... "))],64)):(x(),P(K,{key:1},[v(n(m.value.camp_name||`营期${w.value}`),1)],64))])]),m.value.start_date||m.value.end_date?(x(),P("div",vs,[e[32]||(e[32]=t("span",{class:"info-label"},"营期时间:",-1)),t("span",hs,n(X(m.value.start_date))+" 至 "+n(X(m.value.end_date)),1)])):U("",!0),t("div",fs,[e[34]||(e[34]=t("span",{class:"info-label"},"营期ID:",-1)),i(C,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=I=>w.value=I),size:"small",style:{width:"120px"},placeholder:"营期ID",type:"number"},null,8,["modelValue"]),i(a,{size:"small",type:"primary",onClick:he,icon:O(xe),style:{"margin-left":"10px"}},{default:r(()=>e[33]||(e[33]=[v("刷新")])),_:1},8,["icon"])])]),t("div",_s,[e[35]||(e[35]=t("span",{class:"total-label"},"总佣金:",-1)),t("span",gs,n(H(g.value.total_commission)),1)])]),D.value?(x(),P("div",ys,[i(B,{class:"is-loading"},{default:r(()=>[i(O(ke))]),_:1}),e[36]||(e[36]=t("span",null,"正在加载数据...",-1))])):(x(),J(Y,{key:1,data:g.value.details||[],style:{width:"100%"},stripe:"",border:""},{default:r(()=>[i($,{label:"客户ID",prop:"customer_id",width:"100",align:"center"}),i($,{label:"客户姓名",prop:"customer_name",width:"130",align:"center"}),i($,{label:"佣金金额",width:"150",align:"center"},{default:r(I=>[t("span",ws,n(H(I.row.commission_amount)),1)]),_:1}),i($,{label:"时间",prop:"time","min-width":"180",align:"center"})]),_:1},8,["data"])),!D.value&&!((f=g.value.details)!=null&&f.length)?(x(),P("div",bs,[i(L,{description:"当前营期没有佣金明细记录","image-size":120},{description:r(()=>[t("p",null,"在营期ID: "+n(w.value)+" 中没有任何推广数据",1),e[37]||(e[37]=t("p",{class:"empty-hint"},"您可以尝试查询其他营期或联系管理员",-1))]),_:1})])):!D.value&&((A=g.value.details)!=null&&A.length)?(x(),P("div",xs,[t("div",ks,[t("div",Cs,[e[38]||(e[38]=t("span",{class:"summary-label"},"客户数量:",-1)),t("span",Ms,n(((F=g.value.details)==null?void 0:F.length)||0)+"位",1)]),t("div",Ps,[e[39]||(e[39]=t("span",{class:"summary-label"},"平均佣金:",-1)),t("span",Ds,"￥"+n(pe()),1)])])])):U("",!0)]}),_:1},8,["modelValue"])])}}},As=ge(Is,[["__scopeId","data-v-59fbf30d"]]);export{As as default};
